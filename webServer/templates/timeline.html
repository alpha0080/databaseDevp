<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
      <!-- UI -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/cwtexkai.css">
     <link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/cwtexyen.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/cwtexfangsong.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/notosanstc.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/cwtexming.css">
   


    <!-- input jQuery Mobile js
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
   -->
    <!-- jquery core
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
 -->
	<script src="{{url_for('static', filename='jquery-3.3.1.min.js')}}"></script>
   
   
    <!-- Jquery UI -->
	<link href="{{url_for('static',filename='css/jquery-ui.min.css')}}" rel="stylesheet">

	<script src="{{url_for('static', filename='jquery-ui.min.js')}}"></script>

  
  
  
   <!-- bootstrap CDN 
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>


    -->
    
    
    <!-- bootstrap local -->
    <link href="{{url_for('static',filename='css/bootstrap.min.css')}}" rel="stylesheet">

	<script src="{{url_for('static', filename='bootstrap.min.js')}}"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>

    
    <!-- input dropzoe js 
    <script src="https://rawgit.com/enyo/dropzone/master/dist/dropzone.js"></script>
    <link rel="stylesheet" href="https://rawgit.com/enyo/dropzone/master/dist/dropzone.css">
-->
 
  

    <!-- input bootstrap tag plugin js -->

    <script src="{{url_for('static', filename='tagsinput.js')}}"></script>
    <link href="{{url_for('static',filename='css/tagsinput.css')}}" rel="stylesheet">
    

    <!-- input pixi js -->


    <script src="{{url_for('static', filename='pixi.min.js')}}"></script>
    <script src="{{url_for('static', filename='pixi-spine.js')}}"></script>

    <!-- input full screen js -->

    <script src="{{url_for('static', filename='screenfull.min.js')}}"></script>

    <!-- input Markdown js 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
    -->
    <script src="{{url_for('static', filename='bootstrap-markdown.js')}}"></script>
    <link href="{{url_for('static',filename='css/bootstrap-markdown.css')}}" rel="stylesheet">
    <!--
    <script src="{{url_for('static', filename='timeliner.js')}}"></script>
    <script src="{{url_for('static', filename='Frame.js')}}"></script>
    -->

   



    <link href="{{url_for('static',filename='timeline/css/reset.css')}}" rel="stylesheet">
    <link href="{{url_for('static',filename='timeline/css/timeline.css')}}" rel="stylesheet">
    <script src="{{url_for('static', filename='timeline/js/timeline.js')}}"></script>
    <script src="{{url_for('static', filename='gsap/src/uncompressed/TimelineMax.js')}}"></script>
    <script src="{{url_for('static', filename='gsap/src/uncompressed/TweenMax.js')}}"></script>

    <script src="{{url_for('static', filename='pixi.input.js')}}"></script>
    <script src="{{url_for('static', filename='PixiTextInput.js')}}"></script>
     
    <script src="{{url_for('static', filename='pixiTimeline.js')}}"></script>


        
          <!--
    <script src="{{url_for('static', filename='timeliner.js')}}"></script>
       
           <script src="../src/scripts/bower_components/draggable-number.js/dist/draggable-number.js"></script>

       
        -->
 
    <title>Document</title>
</head>

<style>
#main{
    display:block;
    width:80%;
    padding:50px 10%;
    height:300px;
} 
    
    .tableLnie{
        height: 20px
        
    }

</style>


<body>
	<div class="container">
        <div class="row">
            <div class="col-12">
                main panel
            </div>
            <div class="col-12" id="timelineEditor">
               <canvas class="align-middle w-100 h-100 " id="timelinePixiCanvas" ></canvas>
               
            </div>
            
            
        </div>
        <div class= "row">
            <div class="col-3">
                <button type="button" class="btn btn-primary btn-sm" id="spin">spin</button>
                <button type="button" class="btn btn-primary btn-sm" id="prew">prew</button>
                <button type="button" class="btn btn-primary btn-sm" id="next">next</button>
                <button type="button" class="btn btn-primary btn-sm" id="playBtn">play</button>
            </div>

            <div class="col-9">   
                <div class="input-group-prepend">
                   <label class="input-group-text" for="inputGroupSelect01">current frame</label>
                     <input type="number" class="form-control" min=0 max =1000 step=1 value=0 style="width:  15%" id="timelineCurrentFrame">
                    <label class="input-group-text" for="inputGroupSelect01">start</label>
                     <input type="number" class="form-control" min=0 max =1000 step=1 value=0 style="width:  15%" id="timelineStartInput">
                    <label class="input-group-text" for="inputGroupSelect01">range start</label>
                     <input type="number" class="form-control" min=0 max =1000 step=1 value=0 style="width:  15%" id="rangeStartInput">
                       <label class="input-group-text" for="inputGroupSelect01">range end</label>
                     <input type="number" class="form-control" min=0 max =1000 step=1 value=300 style="width:  15%" id="rangeEndInput">
                      <label class="input-group-text" for="inputGroupSelect01">end</label>
                     <input type="number" class="form-control" min=0 max =1000 step=1 value=1000 style="width:  15%" id="timelineEndInput">

                  </div> 
            </div>
        </div>
        <div class="row">
         
            <div class="col-12 time" id="timelineEditor">
               <canvas  class="align-middle w-100 h-100 " id="timelinePixiControlCanvas" ></canvas>
               
            </div>
            
            
        </div>
        

    
  <!-- Content here -->
  


<script>
  
    
   var app = new PIXI.Application(1920, 1080, {
                        view: document.getElementById('timelinePixiCanvas')
                            }
                );
    
   var timelineApp = new PIXI.Application(1920, 600, {
                        view: document.getElementById('timelinePixiControlCanvas')
                            }
                );
        
    
    
    var loader = PIXI.loader
    loader
        .add('aniA', 'static/uploads/Scatter_bird.json')
      //  .on('complete',defineSpineEvent())
        .load(defineSpineEvent);
    
    //console.log(app)
    //console.log('div',$('#timelinePixiCanvas'))
   //document.body.appendChild(app.view);
    //timeliner.setValues
  //  console.log('timeliner',timeliner,DEFAULT_TIME_SCALE)
    var width_L = 400
    var width_R = 1920 - width_L
    var height =1080
    rectA(app,width_L,height)
    rectB(app,width_R,height,width_L)
    var ruleLeft = width_L+50
    var ruleWidth = width_R-100
    var ruleTop = 10
    var ruleHeight =100
    var fps = 30
    ruleA(0,200,100,600,ruleLeft,ruleWidth,ruleTop,ruleHeight)
    drawArrow()
    currentRedLine(ruleLeft,50)
    drawLine()
    //defineSlotColumn(300,150)
    
    
    //初始化timeline table
    //console.log($('#itemTableHeadSample').height())
   
    
    
    //intial container index
    var labelContainer =  new PIXI.Container();
    labelContainer.name = 'timeline_itemLabel'
    timelineApp.stage.addChild(labelContainer)
    console.log('timelineApp',timelineApp.stage)
    
    
    
    //initial ui 
    
    var timelineScreenW = timelineApp.renderer.screen.width
    var timelineScreenH = timelineApp.renderer.screen.height

    timelineApp.stage.setChildIndex(labelContainer,0)
    
    
    
    
    
    //ui

   
    
 
    vartimelineRuler = creatTimelineRule(timelineApp,0,100,0,1000)
    var pixiTimelinePanel = pixiTimeline(timelineApp,'itemName')
  //  console.log('pixiTimelinePanel',pixiTimelinePanel)
   // createItemLabel(timelineApp,200,32,'symbol_A')
    
    //setItemLabelInTimeline()
    
    
    
    //ui end
    
    $('#spin').click(function(){
        run()
        
        
    })
    
   
    
    
    function setItemLabelInTimeline(){
    //  console.log(labelContainer)
         
        var itemList = labelContainer.children
        for(var i=0;i<itemList.length;i++){
            var setX = -timelineScreenW/2 + itemList[i].width/2 
            var setY =  -timelineScreenH/2 + ((itemList[i].height)/2)*(i+1)
            console.log(itemList[i],setX,setY)

            itemList[i].x = setX
            itemList[i].y = setY
                //itemList[i].width/2 -timelineScreenW/2
            
            
        }
        
        
        
    }
    
    
    $('#prew').click(function(){
        
        var act1 = app.stage.children[7]
        var currentTrack = act1.state.tracks[0]
        currentTrack.trackTime =0
        var currentTrackTime = currentTrack.trackTime
        var lastTime = currentTrack.animationEnd 
        var length = lastTime + 1.0/fps
        console.log('actionA',act1,currentTrack)
     //   console.log('lastTime',lastTime)
        console.log('currentTrackTime',currentTrackTime)
        //currentTrack.trackTime = currentTrackTime +1/fps
        TweenLite.to(currentTrack, length, {trackTime:lastTime});
        
        //TweenLite.from()
    })
    
    
    $('#playBtn').click(function(){
        
        console.log('click play btn')
        console.log('stage',app.stage.children)
        var slotColumn = app.stage.children[2]
       // var slotCounts = slotPoor.length
        
        ////var slotTest = slotPoor[0]
       // console.log('slotPoor',slotPoor,slotCounts,slotTest)
       // var move = new TimelineMax(slotTest, 1, {x:100,y:-300}); 
       // var move2 = new TweenMax(slotTest, 1, {x:100,y:300}); 
        var move = new TimelineMax({repeat:0, repeatDelay:0});
            move.to(slotColumn, 0, {y:0})
            move.to(slotColumn, 6, {ease: Elastic.easeOut.config(1, 0.5),y:2200})
    })
    
   // rectB(app).stage
    $(document).ready( function(){
    //Get the canvas &
   //  var c = $('#timelinePixiCanvas');
      //  var ct = c.get(0).getContext('2d');
      //  var container = $(c).parent();
     //console.log(app.renderer.view.clientWidth)   

    //Run function when browser resizes
    $(window).resize( respondCanvas );
        

     drawRect(100,100,20,5,0xffffff,1,0xaaaaaa,1)   
    })
        
    function run(){
        console.log(app.ticker)
        app.ticker.start()
        var slotColumn_1 = app.stage.children[6]
        timer = 0
        slotColumn_1.y= 0
        app.ticker.add(function(delta){
           // dy += delta
            // deltaS = 10*delta 
            //速率為 每frame 10px   ; deltaS = 10*delta
            //每個 位移一個 slot的時間為  gap / deltaS
            //減速度 ; deltaNS = 20*delta
            timer += delta
        //console.log(delta)
            /*
            if (timer<100){
                slotColumn_1.y += 10
            }else if(timer >= 100 && timer <= 200){
                slotColumn_1.y += (10 - ((timer-100)/10))
            }else if(timer >200){
                app.ticker.stop()
            }
            */
            //slotColumn_1.y += 15
           //  console.log(slotColumn_1.y)
            if(timer >= 100){app.ticker.stop()
                    console.log(slotColumn_1.y)
                            }  //delta = 15*100
            
            
            
            //if (timer >= 100) {app.ticker.stop()}
        })
        
        
    }
    
    function maskA(maskW,maskH){
        var maskA = new PIXI.Graphics
        maskA.beginFill(0xffffff,1)
        maskA.lineStyle(1, 0xffffff, 1);
        maskA.drawRoundedRect(960, 540, maskW, maskH,0);
        maskA.pivot.x=maskW/2
        maskA.pivot.y=maskH/2

        return maskA
    }
    
   

    function defineSlotColumn(count,gap){
         var symbolW =200
         var symbolH =200
         var gap = 20
         var maskW = 300
         var maskH = 700
        var slotPoor = new PIXI.Container();
        slotPoor.name = 'container_slotPoor'
        for(var i=0;i<count;i++){
               
            var slot = drawRect(symbolW,symbolH,20,5,0xffffff,1,0xaaaaaa,1)  
            //slotPoor.push(slot)
           // console.log(slot)
            slot.y = 5*(symbolH+gap) - i*(symbolH+gap)
            slot.x = 0
            slotPoor.addChild(slot)
        } 
        //slotColumn.addChild(slotInColumn)
        var mask = maskA(maskW,maskH)
        //mask.alpha = 1;
        //mask.blendMode =1
        app.stage.addChild(slotPoor)
        app.stage.setChildIndex(slotPoor,2)
        app.stage.addChild(mask)
        slotPoor.mask = mask
    }
    
        
    function drawRect(w,h,r,lineW,lineColor,lineOpti,fillColor,fillOpti){
        var graphic = new PIXI.Graphics
        graphic.beginFill(fillColor,fillOpti)
        graphic.lineStyle(lineW, lineColor, lineOpti);
        //ccenterX = 
        screenW = app.renderer.screen.width
        screenH = app.renderer.screen.height
        graphic.drawRoundedRect(screenW/2-w/2, screenH/2-h/2, w, h,r);
        return graphic
        //app.stage.addChild(graphic)

        
    }
    
    
    function defineSpineEvent(loader,res){
      //  console.log('define spine',loader)
      //  var res = loader.resources
      //  var aniA = res.aniA.spineData
        var act1 =  new PIXI.spine.Spine(res.aniA.spineData);
    //    console.log('act1',act1)
        act1.x = 700
        act1.y = 500
        app.stage.addChild(act1);
     //   console.log(res,Object.keys(res))
        var spineJob = Object.keys(res[Object.keys(res)[0]].data.animations)
       // console.log('spineJob',spineJob)
        var currentTrack0 = act1.state.getCurrent(0)
       // act1.state.setEmptyAnimation (0,0)
        act1.state.setAnimation(0, spineJob[0], true);
        
      //  act1.state.setAnimation(1, "aniA", true);
     //   console.log('act1',act1)
        var tracks = act1.state.tracks
        tracks[0].timeScale =0
      //  tracks[0].delay =3
    //    tracks[0].mixDuration =2
      //  tracks[0].mixTime =3
      //  tracks[1].timeScale  =3
       // console.log(tracks[0])
        //currentTrack0.delay =20
       // act1.state.addEmptyAnimation (0,0,0)
      //  act1.stage.addAnimation(0,"testAction", true,10.0)
       // act1.stage.addAnimation(0,'aniA', true,10.0)

        var currentTrack0 = act1.state.getCurrent(0)

        console.log('currentTrack0',currentTrack0)

        //act1.state.setEmptyAnimation (0,0)
       // act1.state.addEmptyAnimation (0,0,0)
       // act1.mixDuration = 1;
      //  addEmptyAnimation (	int trackIndex, float mixDuration, float delay)
        
        }
    
    function respondCanvas(){
        var width = app.renderer.view.clientWidth
       // c.attr('width', $(container).width() ); //max width
        //c.attr('height', $(container).height() ); //max height
        //console.log(app.render)
     //   console.log(app.renderer.view.clientWidth)   
   
        
        // console.log($('#timelineEditor').width())   
        //rectA(app,width)
        //Call a function to redraw other content (texts, images etc)

    }

    function drawLine(){
        var line = new PIXI.Graphics();
        line.lineStyle(1, 0xff0000, 1);
        line.moveTo(960,0);
        line.lineTo(960,1080)
        line.moveTo(0,540)
        line.lineTo(1920,540)
        line.zOrder =99
        
        app.stage.addChild(line);
        
    }
   
    
     function currentRedLine(ruleLeft,offset){
         console.log('drawline')
        var redLine = new PIXI.Graphics();
        redLine.lineStyle(1, 0xff0000, 1);
        redLine.moveTo(ruleLeft+offset,0);
        redLine.lineTo(ruleLeft+offset, 1200);
        
        app.stage.addChild(redLine);

    }
    
    
    
    
    function rectA(app,w,h){
        var graphics = new PIXI.Graphics();
        //graphics.lineStyle(2, 0x4D4D4D, 1);
        graphics.beginFill(0x4D4D4D, 1);
        graphics.drawRoundedRect(0, 0, w, h, 0);
        graphics.endFill();
        
        app.stage.addChild(graphics);

    }
    
     function rectB(app,w,h,left){
        var graphics = new PIXI.Graphics();
           // graphics.lineStyle(2, 0x0000FF, 1);
            graphics.beginFill(0xCCCCCC, 1);
            graphics.drawRect(left, 0, w, h);
        
        app.stage.addChild(graphics);

    }
    
    function drawArrow(){
        var graphics = new PIXI.Graphics();
        graphics.lineStyle(2, 0xFF0000, 1);
        graphics.beginFill(0xC66666, 1);

        graphics.moveTo(-20,0);
        graphics.lineTo(20,0);
        graphics.lineTo(0,100);
        graphics.lineTo(-20,0);
        graphics.x= 960
        graphics.y= 540

        app.stage.addChild(graphics);
        
    }
   
    
    function ruleA(minFrame,maxFrame,viewMinFrame,viewMaxFrame,left,w,top,h){
        var ruler = new PIXI.Container();

        var graphics = new PIXI.Graphics();
       // graphics.lineStyle(2, 0x0000FF, 1);
        graphics.beginFill(0xA9C4EB, 1);
        graphics.drawRect(left, top, w, h);

        graphics.lineStyle(1, 0x000000, 1);
      
        var divV = (viewMaxFrame-viewMinFrame)
        var divSpace = w/divV
        var div5 = (viewMaxFrame-viewMinFrame)/5
        var divSpace5 = w/div5
        var div10 = (viewMaxFrame-viewMinFrame)/10
        var divSpace10 = w/div10
       
        console.log('divV',divV,divSpace)
        graphics.zOrder =0
        ruler.addChild(graphics)
        app.stage.addChild(ruler);

        var style = new PIXI.TextStyle({
        fontFamily: 'Arial',
        fontSize: 16,
        fontStyle: 'normal',
        fontWeight: 'light', 
        align:'left'
            });
        if(divSpace >= 20){
            for(var i =0;i<(divV+1);i++){
            graphics.moveTo(left+(i*divSpace),top);
            graphics.lineTo(left+(i*divSpace), top+30);
            var bigNum = new PIXI.Text((viewMinFrame+i),style);
            bigNum.x= left+(i*divSpace)
            bigNum.y = top+40
            bigNum.zOrder = 30
            ruler.addChild(bigNum);
            }   
        }else if(divSpace < 20 && divSpace >= 10){
            for(var i =0;i<(div5+1);i++){
            graphics.moveTo(left+(i*divSpace5),top);
            graphics.lineTo(left+(i*divSpace5), top+30);
            var bigNum = new PIXI.Text((viewMinFrame+i*5),style);
            bigNum.x= left+(i*divSpace5)
            bigNum.y = top+40
            bigNum.zOrder = 30
            ruler.addChild(bigNum);
            }  
        }else if(divSpace < 10){
            console.log('divSpace10',divSpace,div10)
            for(var i =0;i<(div10+1);i++){
            graphics.moveTo(left+(i*divSpace10),top);
            graphics.lineTo(left+(i*divSpace10), top+30);
            var bigNum = new PIXI.Text((viewMinFrame+i*10),style);
            bigNum.x= left+(i*divSpace10)
            bigNum.y = top+40
            bigNum.zOrder = 30
            ruler.addChild(bigNum);
            } 
            
            
            
        }
        
        ruler.name ='container_ruler'
       
        
        
        
        
    }
    
    

</script>



</html>